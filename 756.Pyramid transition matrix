from typing import List
from collections import defaultdict
from functools import lru_cache

class Solution:
    def pyramidTransition(self, bottom: str, allowed: List[str]) -> bool:
        mp = defaultdict(list)
        for a, b, c in allowed:
            mp[(a, b)].append(c)
        @lru_cache(None)
        def dfs(curr: str) -> bool:
            if len(curr) == 1:
                return True
            def build(idx: int, next_row: list) -> bool:
                if idx == len(curr) - 1:
                    return dfs("".join(next_row))
                pair = (curr[idx], curr[idx + 1])
                if pair not in mp:
                    return False
                for ch in mp[pair]:
                    next_row.append(ch)
                    if build(idx + 1, next_row):
                        return True
                    next_row.pop()
                return False
            return build(0, [])
        return dfs(bottom)
